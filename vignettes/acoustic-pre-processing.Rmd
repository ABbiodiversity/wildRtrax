---
title: 'Acoustic pre-processing'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Acoustic pre-processing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The following set of functions help to pre-process and organize audio and corresponding metadata. In conjunction, these tools allow you to select recordings parameterized to a specific study design.

# Data pre-processing

- \code`wt_audio_scanner()` scans a directory of audio files and prepares them in a tibble with WildTrax formatted columns. 
- \code`wt_run_ap()` allows you to generate acoustic indices and false-colour spectrograms from a \code`wt_audio_scanner()` tibble, while \code`wt_glean_ap()` wrangles the output into summary plots and LDFCs. 
- \code`wt_signal_level()` detects signals in audio based on amplitude thresholds. 
- \code`wt_chop()` divides a large audio file into shorter segments.

```{r, include = FALSE, echo = F, include = T, warning = F, message = F}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = '#>'
)

library(wildRtrax)
library(tidyverse)

# Set the directory path
load("book.RData")
#save.image("book.RData")

```

## Scanning audio files from a directory

The `wt_audio_scanner()` function reads in audio files (either wac, wav or flac format) from a local directory and outputs useful metadata.

```{r, echo=TRUE, include=TRUE, eval=T, warning = F, message = F}
# Scan data

if (dir.exists(".")) {
  wt_audio_scanner(path = ".", file_type = "wav", extra_cols = T)
} else {
  'Can\'\t find this directory'
}

```

You might want to select recordings between certain times of day or year, or filter recordings based on some criteria.

```{r, echo=TRUE, include=TRUE, eval=T, warning = F, message = F}
files %>%
  select(-file_path)

```

```{r, echo=TRUE, include=TRUE, eval=T, warning = F, message = F}
library(lubridate)

files %>%
  mutate(hour = hour(recording_date_time)) %>%
  filter(julian == 176, 
         hour %in% c(4:8))

```

## Running the QUT Ecoacoustics AnalysisPrograms software on a wt_* standard data set

The `wt_run_ap()` function allows you to run the QUT Analysis Programs [(AP.exe)](https://ap.qut.ecoacoustics.info/) on your audio data. AP generates acoustic index values and false-colour spectrograms for each audio minute of data. Note that you must have the AP program installed on your computer. See more here [(Towsey et al., 2018)](https://researchoutput.csu.edu.au/ws/portalfiles/portal/28556441/28544328_Published_article.pdf). 

```{r echo=TRUE, include=T, eval=F, warning = F, message = F}
#Use the wt_* tibble to execute the AP on the files

wt_run_ap(x = my_files, output_dir = paste0(root, 'ap_outputs'), path_to_ap = '/where/you/store/AP')

```

The use `wt_glean_ap` to plot the acoustic index and LDFC results

```{r, echo=T, include=T, eval=F, warning=F, message, prompt=T, comment=""}

wt_glean_ap()

```

## Applying a limited amplitude filter

We can use the `wt_signal_level()` function to search for sounds that exceed a certain amplitude threshold. 

```{r, echo=T, include=TRUE, eval=F, warning=F, message=F}
if (dir.exists(".")) {
  signal_file <- wt_audio_scanner(path = ".", file_type = "wav", extra_cols = T)
} else {
  'Can\'\t find this directory'
}

wt_signal_level(path = signal_file$file_path, 
                     fmin = 0, 
                     fmax = 10000, 
                     threshold = 5, 
                     channel = 'left')

```

```{r, eval = F}
# Run
s
# Return a list object, with parameters stored
str(s)

# We can view the output:
s['output']
# We have eleven detections that exceeded this threshold.

```

# Linking files to WildTrax

Make tasks at any time using a `wt_*` standard data set.

```{r, include = T, eval=F, warning=F, message=F}
wt_make_aru_tasks(input = files %>% select(-file_path), task_method = "1SPT", task_length = 180)
```

The function `wt_songscope_tags` reformats the output obtained from a wildlife acoustics songscope recognizer. This transformation involves converting the recognizer tags into tags that do not have a method type. This makes it possible to upload each hit as a tag in a task.

```{r, include = T, eval=F, warning=F, message=F, prompt="", prompt=T}
wt_songscope_tags()
```

Similarly, the function `wt_kaleidoscope_tags` performs the same reformatting process, but with Kaleidoscope instead. It is worth noting that this function targeted for sonic and ultrasonic species upload.

```{r, include = T, eval=F, warning=F, message=F}
wt_kaleidoscope_tags()

```

